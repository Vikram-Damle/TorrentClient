<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Torrent Client</title>
    
</head>
<body>
    <h1>Torrent Client</h1>
    <div id="select-torrent">
        <label for="torrent-file">Select torrent file: </label>
        <input type="file" id="torrent-file">
    </div>
    <table>
        <tbody id='file-list'>
        </tbody>
    </table>
    <div id="progress-det" style="margin:20px 0 5px 20px; display: none;">
        <span id="progress-perc">Starting Download...</span>
        <span id="progress-rtime"></span>
        <span id="progress-speed"></span>
    </div>
    <div id="progress-bar" style="height: 10px; background: #ddd; margin: 0 20px 20px 20px; border-radius: 5px; display: none;">
        <div id="progress-curr" style="height: 10px; width: 0; background: rgb(135, 226, 90); border-radius: 5px;"></div>
    </div>
    <button id='start-btn' style="display: none;">Start</button>
    <button id='show-dl' style='display: none;'>Show in Folder</button>
    <button id='exit-btn' style="background: #f00; color: #fff; border: none; padding: 5px; border-radius: 5px; position: absolute; top: 20px; right: 20px;">Exit</button>
</body>

<template id="file-det-temp">
    <tr class="file-det">
        <td class="file-name"></td>
        <td class="file-size"></td>
        <td>
            <input type="checkbox" class="file-checkbox">
        </td>
    </tr>
</template>

<script>
    let ws = new WebSocket("ws://localhost:9494");
    let fileList = document.getElementById('file-list');

    let lastBlockTime = null;
    let ctr=0;

    ws.onopen = function(e){
        //ws.send(JSON.stringify({type:'init'}));
        console.log('connected')
        document.getElementById('start-btn').onclick=startDl;
        window.onbeforeunload = ()=>{
            ws.send(JSON.stringify({type:'exit'}));
        }
        document.getElementById('exit-btn').onclick=()=>{
            ws.send(JSON.stringify({type:'exit'}));
            window.close();
        }
    };
    ws.onclose = function(e){
        alert('Server Disconnected! Click OK to exit.');
        window.close();
    };
    ws.onmessage = function(e){
        let data = JSON.parse(e.data);
        if(data.type=='file-list'){
            fileList.innerHTML='';
            data.data.forEach((file,ind) => {
                var temp=document.getElementById('file-det-temp')
                var entry = temp.content.cloneNode(true);
                entry.querySelector('.file-name').textContent=file.name;
                entry.querySelector('.file-size').textContent=file.size;
                entry.querySelector('.file-checkbox').setAttribute('data-id',ind+1);
                entry.querySelector('.file-checkbox').onclick = toggleStartBtn;
                fileList.appendChild(entry);
            });
        }
        else if(data.type=='text'){
            console.log(data.data);
        }
        else if(data.type=='update-progress'){
            console.log(data.data.total);
            let perc = (100*data.data.completed/data.data.total).toFixed(1);
            document.getElementById('progress-curr').style.width = perc+'%'; 
            document.getElementById('progress-perc').textContent = perc+'%'; 
            ctr++;

            if(ctr==10){
                let remTime = -1;
                if(!lastBlockTime)
                    lastBlockTime=Date.now();
                else{
                    remTime = (Date.now()-lastBlockTime)*(data.data.total-data.data.completed)/10;
                    speed = 16*10*1000/(Date.now()-lastBlockTime);
                    lastBlockTime=Date.now();
                }
                if(remTime!=-1){
                    document.getElementById('progress-rtime').textContent = Math.floor(remTime/1000) + ' s remaining...'; 
                    document.getElementById('progress-speed').textContent = speed.toFixed(1) + ' KB/s'; 
                }
                ctr=0;
            }
            
        }
        else if(data.type=='finished'){
            alert('Download Complete!');
            document.getElementById('show-dl').style.display = 'block'; 
            document.getElementById('show-dl').onclick=(e)=>{
                ws.send(JSON.stringify({type:'show-dl'}));
            }
        }
    }
    function startDl(){
        let toDl='';
        [].forEach.call(document.getElementsByClassName('file-checkbox'),(ele)=>{
            console.log(ele);
            if(ele.checked){
                toDl+=ele.getAttribute('data-id') + ' ';
            }else{
                ele.parentElement.parentElement.style.color='#ddd'
            }
            ele.style.display='none';
        });
        console.log(toDl);
        document.getElementById('start-btn').style.display='none';
        document.getElementById('progress-bar').style.display='block';
        document.getElementById('progress-det').style.display='block';
        document.getElementById('select-torrent').style.display='none'
        ws.send(JSON.stringify({type:'start',data:toDl}));
    }

    document.getElementById('torrent-file').onchange = function(e){
        const file = e.target.files[0];
        let filename = this.value.split('\\');
        filename = filename[filename.length - 1];
        let reader = new FileReader();
        let rawData = new ArrayBuffer();
        reader.onload = function(e){
            rawData = e.target.result;
            ws.send(JSON.stringify({type:'torrent-file',data:filename}));
            ws.send(rawData);
            ws.send(JSON.stringify({type:'init'}));
            tempBuffer = rawData;
        }
        reader.readAsArrayBuffer(file);
        
        
    }

    function toggleStartBtn(){
        let flag = false;
        [].forEach.call(document.getElementsByClassName('file-checkbox'),(ele)=>{
            if(ele.checked)flag=true;
        });
        document.getElementById('start-btn').style.display=(flag)?'block':'none';
    }
</script>
</html>